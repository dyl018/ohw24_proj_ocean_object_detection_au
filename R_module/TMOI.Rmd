---
title: "TMOI"
output: html_document
date: "2024-08-28"
---

---
title: "marinedebris"
output: html_document
date: "2024-08-27"
---

**Install packages**
```{r}
install.packages ("rstac")
install.packages ("sf")
install.packages ("stars")
install.packages ("terra")
install.packages ("raster")
```

**Load libraries** 
```{r}
library(rstac)
library(sf)
library(stars)
library(terra) 
library(raster)
library(sp)
```

**Define AOI**
```{r}
bbox <- st_bbox(c(xmin=-0.4005585, ymin=5.422245, 
                 xmax=-0.1936628, ymax=5.544341),
                 crs=4326)
```

**Define start and end date of data acqusition**
```{r}
start_date <- "2018-10-31" 
end_date <- "2018-11-01"
```


**Access the Sentinel-2 Database**
```{r}
url_dataspace <-"https://planetarycomputer.microsoft.com/api/stac/v1/"
level = "sentinel-2-l2a"
```


**The query command to obtain the data**
```{r}
matches <- 
  stac(url_dataspace) |>
  stac_search(collections = level,
              bbox = bbox,
              datetime = "2018-10-31/2018-11-01") |>
  get_request() |>
  items_sign(sign_fn = sign_planetary_computer())
```

```{r}
best_img <- matches$features[[1]]
```


```{r}
red <- read_stars( paste0("/vsicurl/", best_img$assets$B04$href) )
bbox_proj <- bbox |> st_as_sfc() |> st_transform(st_crs(red)) |> vect()
```

**Extract each band**
```{r}
blue_r <- rast( paste0("/vsicurl/", best_img$assets$B02$href) )|> crop(bbox_proj)
green_r <- rast( paste0("/vsicurl/", best_img$assets$B03$href) )|> crop(bbox_proj)
red_r <- rast( paste0("/vsicurl/", best_img$assets$B04$href) )|> crop(bbox_proj)
rededge_r <- rast( paste0("/vsicurl/", best_img$assets$B06$href) )|> crop(bbox_proj)
nir_r <- rast( paste0("/vsicurl/", best_img$assets$B08$href) )|> crop(bbox_proj)
swir_r <- rast( paste0("/vsicurl/", best_img$assets$B11$href) )|> crop(bbox_proj)
```

**Convert to Raster**
```{r}
Blue <- raster(blue_r)
Green <- raster(green_r)
Red <- raster(red_r)
Rededge <- raster(rededge_r)
NIR <- raster(nir_r)
SWIR <- raster(swir_r)
```

**Resample Rededge2 and SWIR 2 from 20m to 10m**
```{r}
Rededge2 <- resample(Rededge, NIR, method='bilinear')
SWIR2 <- resample(SWIR, NIR, method='bilinear')
```

**Plot RGB**
```{r}
file_list <- c(Blue, Green, Red)
raster_stack <- stack(file_list)
plotRGB(raster_stack, scale = 1, stretch = "lin")
```

**Save Raster**
```{r}
writeRaster(raster_stack, "./Accra.tif", overwrite=TRUE)
```


**Masking Land**
```{r}
# Create a new raster by comparing Blue and NIR
mask_Blue <- overlay(Blue, SWIR2, fun = function(Blue, SWIR2) {
  ifelse(Blue >= SWIR2, Blue, NA)
})

mask_Green <- overlay(Blue, Green, SWIR2, fun = function(Blue, Green, SWIR2) {
  ifelse(Blue >= SWIR2, Green, NA)
})

mask_Red <- overlay(Blue, Red, SWIR2, fun = function(Blue, Red, SWIR2) {
  ifelse(Blue >= SWIR2, Red, NA)
})

mask_Rededge2 <- overlay(Blue, Rededge2, SWIR2, fun = function(Blue, Rededge2, SWIR2){
  ifelse(Blue >= SWIR2, Rededge2, NA)
})

mask_NIR <- overlay(Blue, NIR, SWIR2, fun = function(Blue, NIR, SWIR2) {
  ifelse(Blue >= SWIR2, NIR, NA)
})

mask_SWIR2 <- overlay(Blue, SWIR2, fun = function(Blue, SWIR2) {
  ifelse(Blue >= SWIR2, SWIR2, NA)
})

file_list <- c(mask_Blue, mask_Green, mask_Red)
maskraster_stack <- stack(file_list)
# Plot the RGB composite
plot(mask_Blue)
plot(mask_Green)
plot(mask_Red)
plot(mask_Rededge2)
plot(mask_NIR)
plot(mask_SWIR2)
plotRGB(maskraster_stack, scale = 1, stretch = "lin")

```

**Save image without land**
```{r}
writeRaster(maskraster_stack, "./maskAccra.tiff", overwrite=TRUE)
```

**Calculate NDVI**
```{r}
NDVI <-(mask_NIR-mask_Red)/(mask_NIR+mask_Red)
NDVI  |> plot()
```

**Calculate FDI**
```{r}
FDI <- mask_NIR-(mask_Rededge2+(mask_SWIR2-mask_Rededge2)*((842-665)/(1610-665))*10)
FDI  |> plot()
```

**Unsupervised Classification**
NDVI
```{r}
nr <- getValues(NDVI)
nr.km <- kmeans(na.omit(nr), centers = 2, iter.max = 500, nstart = 3, algorithm="Lloyd")
MOI_NDVI <- NDVI
MOI_NDVI[] <- nr.km$cluster
plot(MOI_NDVI, main = 'Unsupervised classification of Sentinel data')
```
FDI
```{r}
nr <- getValues(FDI)
nr.km <- kmeans(na.omit(nr), centers = 2, iter.max = 500, nstart = 3, algorithm="Lloyd")
knr <- FDI
knr[] <- nr.km$cluster
plot(knr, main = 'Unsupervised classification of Sentinel data')
```

**Visualisation**
```{r}

plot(MOI_NDVI, main = 'Oil Spill Map', legend = F,
     col = c('red', 'white'),
     )
legend('left', legend = c('Non oil spill', 'Oil spill'),
       fill = c('red', 'white'),
       border = FALSE,
       bty = 'n',
       xpd = T,horiz = F,
       inset = c(0.99, 1))
writeRaster(maskraster_stack, "./MOI_NDVI.tif", overwrite=TRUE)
```

**convert raster to shapefile**
```{r}
# Load the raster
raster_data <- raster("MOI_NDVI.tif")

# Example: Creating a polygon manually
coords <- matrix(c(800000, 602000, 811000, 602000, 811000, 612000, 800000, 612000, 800000, 602000), ncol = 2, byrow = TRUE)
polygon <- Polygon(coords)
polygons <- Polygons(list(polygon), "1")
polygon_data <- SpatialPolygons(list(polygons), proj4string = CRS(proj4string(raster_data)))

# Add the polygon to the plot
plot(raster_data)
plot(polygon_data, add = TRUE, border = "blue", lwd = 2)

# Crop the raster using the polygon
cropped_raster <- crop(raster_data, polygon_data)
plot(cropped_raster)

# Oilspill_rast <- cropped_raster == 1
# plot(Oilspill_rast)
polygon_data <- rasterToPolygons(cropped_raster, dissolve = TRUE)
# writeOGR(polygon_data, dsn = "./Oilspill.shp", layer = "polygon_data", driver = "ESRI Shapefile")
```




